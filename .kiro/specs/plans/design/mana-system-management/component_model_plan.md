# 魔力システム管理ユニット - コンポーネントモデル設計計画

## 概要
魔力システム管理ユニットのコンポーネントモデルを設計し、ユーザーストーリー2.2「魔力システムによるリソース管理」を実装するための詳細設計を行います。

## 設計ステップ

### フェーズ1: 要件分析と確認
- [ ] **ステップ1.1**: ユーザーストーリーの受入基準を詳細分析
  - 初期魔力値（10ポイント）の設定
  - 1秒ごとの魔力増加（1ポイント）
  - 魔力上限（99ポイント）の制御
  - カード魔力コスト（3-30ポイント）の管理

- [ ] **ステップ1.2**: 他ユニットとのインターフェース要件確認
  - ゲームセッション管理ユニットとの連携仕様
  - カード・戦略管理ユニットとの魔力消費インターフェース
  - UI・フィードバックシステムとの状態表示インターフェース

- [ ] **ステップ1.3**: 技術的制約と非機能要件の確認
  - **確認事項**: 魔力生成の1秒間隔は正確にリアルタイムである必要がありますか？それともゲーム内時間ベースですか？
  - **確認事項**: ゲーム一時停止時の魔力生成動作はどうすべきですか？
  - **確認事項**: 魔力消費の失敗時（不足時）のエラーハンドリング方針は？

### フェーズ2: ドメインモデル設計
- [ ] **ステップ2.1**: 魔力システムのコアエンティティ設計
  - ManaPool（魔力プール）エンティティの設計
  - ManaTransaction（魔力取引）バリューオブジェクトの設計

- [ ] **ステップ2.2**: ドメインサービス設計
  - ManaGenerationService（魔力生成サービス）
  - ManaConsumptionService（魔力消費サービス）
  - ManaValidationService（魔力検証サービス）

- [ ] **ステップ2.3**: ドメインイベント設計
  - ManaGenerated（魔力生成イベント）
  - ManaConsumed（魔力消費イベント）
  - ManaCapReached（魔力上限到達イベント）

### フェーズ3: アプリケーションサービス設計
- [ ] **ステップ3.1**: ユースケース実装サービス設計
  - StartManaGenerationUseCase（魔力生成開始）
  - ConsumeManaUseCase（魔力消費）
  - GetManaStatusUseCase（魔力状態取得）

- [ ] **ステップ3.2**: 外部インターフェース設計
  - 他ユニットとの通信インターフェース
  - イベント発行・購読インターフェース

### フェーズ4: インフラストラクチャ設計
- [ ] **ステップ4.1**: リポジトリ設計
  - ManaPoolRepository（魔力プール永続化）
  - **確認事項**: 魔力状態の永続化は必要ですか？ゲームセッション中のみのメモリ管理で十分ですか？

- [ ] **ステップ4.2**: タイマー・スケジューラ設計
  - ManaGenerationTimer（魔力生成タイマー）
  - **決定事項**: ハイブリッド方式（setInterval + deltaTime計算）を採用
    - 100ms間隔のsetIntervalで定期実行
    - Date.now()によるdeltaTime計算で精度確保
    - ゲーム一時停止時は魔力生成も停止
    - 魔力不足時のカードグレーアウト演出対応

### フェーズ5: コンポーネント相互作用設計
- [ ] **ステップ5.1**: コンポーネント間の依存関係マッピング
- [ ] **ステップ5.2**: データフロー設計
- [ ] **ステップ5.3**: エラーハンドリングフロー設計

### フェーズ6: 設計文書作成
- [ ] **ステップ6.1**: コンポーネントモデル図作成
- [ ] **ステップ6.2**: インターフェース仕様書作成
- [ ] **ステップ6.3**: シーケンス図作成

## 確認が必要な事項

1. **魔力生成タイミング**: ゲーム内時間ベース（決定済み）
2. **ゲーム一時停止時の動作**: 魔力生成を停止する（決定済み）
3. **魔力状態の永続化**: メモリ管理のみでOK（決定済み）
4. **タイマー実装方式**: ハイブリッド方式（決定済み）
5. **エラーハンドリング方針**: 魔力不足時のカードグレーアウト演出（決定済み）

## 追加設計要件

### ハイブリッドタイマー仕様
- **更新間隔**: 100ms
- **精度計算**: deltaTime = Date.now() - lastUpdateTime
- **魔力増加量**: (deltaTime / 1000) * manaRegenRate
- **一時停止制御**: isPaused フラグによる生成停止
- **UI連携**: 魔力変化時のリアルタイム表示更新

## 成果物
- `.kiro/specs/design-artifacts/mana-system-management/component_model.md`
- `.kiro/specs/design-artifacts/mana-system-management/interface_specification.md`
- `.kiro/specs/design-artifacts/mana-system-management/sequence_diagrams.md`