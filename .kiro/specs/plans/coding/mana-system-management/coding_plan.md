# 魔力システム管理ユニット - 実装計画

## 概要
魔力システム管理ユニットのコンポーネントモデルに基づいて、TDD/DDD原則に従った実装を行います。TypeScript + Bunを使用し、Biomeでコード品質を管理します。

## 実装ステップ

### フェーズ1: ドメイン層の実装
- [x] **ステップ1.1**: ドメインエンティティのテスト実装
  - [x] ManaPoolエンティティのテスト作成
  - [x] ManaTransactionバリューオブジェクトのテスト作成
  - [x] ドメインイベントのテスト作成

- [x] **ステップ1.2**: ドメインエンティティの実装
  - [x] ManaPoolエンティティの実装
  - [x] ManaTransactionバリューオブジェクトの実装
  - [x] ドメインイベント（ManaGeneratedEvent, ManaConsumedEvent, ManaCapReachedEvent）の実装

- [x] **ステップ1.3**: ドメインサービスのテスト実装
  - [x] ManaGenerationServiceのテスト作成
  - [x] ManaConsumptionServiceのテスト作成
  - [x] ManaValidationServiceのテスト作成

- [x] **ステップ1.4**: ドメインサービスの実装
  - [x] ManaGenerationServiceの実装
  - [x] ManaConsumptionServiceの実装
  - [x] ManaValidationServiceの実装

### フェーズ2: アプリケーション層の実装
- [x] **ステップ2.1**: ユースケースのテスト実装
  - [x] StartManaGenerationUseCaseのテスト作成
  - [x] ConsumeManaUseCaseのテスト作成
  - [x] GetManaStatusUseCaseのテスト作成

- [x] **ステップ2.2**: ユースケースの実装
  - [x] StartManaGenerationUseCaseの実装
  - [x] ConsumeManaUseCaseの実装
  - [x] GetManaStatusUseCaseの実装

### フェーズ3: インフラストラクチャ層の実装
- [x] **ステップ3.1**: リポジトリのテスト実装
  - [x] InMemoryManaPoolRepositoryのテスト作成

- [x] **ステップ3.2**: リポジトリの実装
  - [x] ManaPoolRepositoryインターフェースの実装
  - [x] InMemoryManaPoolRepositoryの実装

- [x] **ステップ3.3**: タイマーシステムのテスト実装
  - [x] HybridManaTimerのテスト作成
  - [x] ゲーム時間ベース魔力生成のテスト作成
  - [x] **重要**: 一時停止バグ防止テスト（一時停止直後の再開で不正な魔力生成が発生しないことを確認）

- [x] **ステップ3.4**: タイマーシステムの実装
  - [x] ManaGenerationTimerインターフェースの実装
  - [x] HybridManaTimerの実装

- [x] **ステップ3.5**: イベントバスのテスト実装
  - [x] EventBusのテスト作成

- [x] **ステップ3.6**: イベントバスの実装
  - [x] EventBusインターフェースの実装
  - [x] InMemoryEventBusの実装

### フェーズ4: 統合テストと最適化
- [x] **ステップ4.1**: 統合テストの実装
  - [x] 魔力生成フローの統合テスト
  - [x] 魔力消費フローの統合テスト
  - [x] エラーハンドリングの統合テスト
  - [x] **重要**: 一時停止シナリオの統合テスト（様々なタイミングでの一時停止/再開）

- [x] **ステップ4.2**: パフォーマンステスト
  - [x] 3分間連続動作テスト
  - [x] メモリリーク検出テスト
  - [x] 精度検証テスト（累積誤差15%以下）

- [x] **ステップ4.3**: コード品質チェック
  - [x] Biomeによるlint/format実行
  - [x] TypeScriptコンパイルエラーの解決
  - [x] テストカバレッジの確認

### フェーズ5: 外部インターフェース実装
- [x] **ステップ5.1**: 外部システム連携インターフェース
  - [x] ゲームセッション管理ユニットとの連携インターフェース
  - [x] カード・戦略管理ユニットとの連携インターフェース
  - [x] UI・フィードバックシステムとの連携インターフェース

- [x] **ステップ5.2**: 最終統合テスト
  - [x] 全機能の統合テスト実行
  - [x] エラーケースの網羅的テスト
  - [x] パフォーマンス要件の最終確認

## 確認が必要な事項

### 技術的仕様（確定済み）
1. **タイマー精度**: 100ms間隔での更新
2. **ゲーム一時停止**: ゲーム時間ベース方式（ゲームセッション管理からゲーム経過時間を取得）
3. **エラーハンドリング**: 魔力不足時のUI表示（カードグレーアウト）
4. **イベント配信**: 他ユニットへのイベント配信方法（同期/非同期）

### 重要な実装ポイント
- **一時停止バグ防止**: ゲーム時間ベースで魔力生成を管理し、一時停止直後の再開で不正な魔力生成が発生しないよう徹底的にテスト

### ビジネスロジック（確定済み）
1. **初期魔力値**: 10ポイント
2. **魔力上限**: 99ポイント
3. **生成レート**: 1秒1ポイント（ゲーム時間ベース）
4. **カードコスト範囲**: 3-30ポイント（将来変更の可能性あり）

## 成果物
- `src/domain/entities/` - ドメインエンティティ
- `src/domain/services/` - ドメインサービス
- `src/domain/value-objects/` - バリューオブジェクト
- `src/application/use-cases/` - ユースケース
- `src/infrastructure/repositories/` - リポジトリ実装
- `src/infrastructure/timers/` - タイマー実装
- `src/infrastructure/events/` - イベントバス実装
- `tests/` - 対応するテストファイル

## 次のステップ
この計画の承認後、フェーズ1から順次実行し、各ステップ完了時にチェックボックスを更新します。